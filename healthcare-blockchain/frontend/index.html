<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Healthcare Blockchain System</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .tabs {
        display: flex;
        background: #f5f5f5;
        border-bottom: 2px solid #ddd;
      }

      .tab {
        flex: 1;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        background: #f5f5f5;
        border: none;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s;
      }

      .tab:hover {
        background: #e0e0e0;
      }

      .tab.active {
        background: white;
        color: #667eea;
        border-bottom: 3px solid #667eea;
      }

      .content {
        padding: 30px;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
        animation: fadeIn 0.5s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: border 0.3s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .wallet-info {
        background: #f0f4ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
      }

      .status {
        padding: 10px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .record-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
      }

      .record-card h4 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üè• Healthcare Blockchain System</h1>
        <p>Secure, Transparent, Decentralized Health Records</p>
      </div>

      <div class="wallet-info" id="walletInfo">
        <strong>üì± Wallet Status:</strong>
        <span id="walletStatus">Not Connected</span><br />
        <strong>üë§ Address:</strong> <span id="walletAddress">-</span>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('connect', event)">
          üîó Connect
        </button>
        <button class="tab" onclick="showTab('patient', event)">
          üë§ Patient
        </button>
        <button class="tab" onclick="showTab('doctor', event)">
          üë®‚Äç‚öïÔ∏è Doctor
        </button>
        <button class="tab" onclick="showTab('admin', event)">‚öôÔ∏è Admin</button>
      </div>

      <div class="content">
        <div id="connect" class="tab-content active">
          <h2>Connect to Blockchain</h2>
          <div class="form-group">
            <label>Contract Address:</label>
            <input
              type="text"
              id="contractAddress"
              placeholder="0x5FbDB2315678afecb367f032d93F642f64180aa3"
              value="0x5FbDB2315678afecb367f032d93F642f64180aa3"
            />
          </div>
          <button onclick="connectWallet()">Connect MetaMask</button>
          <div id="connectStatus"></div>
        </div>

        <div id="patient" class="tab-content">
          <h2>Patient Dashboard</h2>

          <div class="grid">
            <div>
              <h3>Register as Patient</h3>
              <div class="form-group">
                <label>Name:</label>
                <input type="text" id="patientName" placeholder="John Doe" />
              </div>
              <div class="form-group">
                <label>Age:</label>
                <input type="number" id="patientAge" placeholder="30" />
              </div>
              <div class="form-group">
                <label>Blood Group:</label>
                <select id="patientBloodGroup">
                  <option>A+</option>
                  <option>A-</option>
                  <option>B+</option>
                  <option>B-</option>
                  <option>O+</option>
                  <option>O-</option>
                  <option>AB+</option>
                  <option>AB-</option>
                </select>
              </div>
              <button onclick="registerPatient()">Register</button>
              <div id="patientRegisterStatus"></div>
            </div>

            <div>
              <h3>My Records</h3>
              <button onclick="getMyRecords()">Load My Records</button>
              <div id="myRecords"></div>
            </div>
          </div>

          <div style="margin-top: 30px">
            <h3>Access Control</h3>
            <div class="form-group">
              <label>Doctor Address (to grant access):</label>
              <input
                type="text"
                id="grantDoctorAddress"
                placeholder="0x70997970C51812dc3A010C7d01b50e0d17dc79C8"
              />
            </div>
            <button onclick="directGrantAccess()">Grant Access Directly</button>
            <div id="accessStatus"></div>
          </div>
        </div>

        <div id="doctor" class="tab-content">
          <h2>Doctor Dashboard</h2>

          <div class="grid">
            <div>
              <h3>Register as Doctor</h3>
              <div class="form-group">
                <label>Name:</label>
                <input type="text" id="doctorName" placeholder="Dr. Smith" />
              </div>
              <div class="form-group">
                <label>Specialization:</label>
                <input type="text" id="doctorSpec" placeholder="Cardiology" />
              </div>
              <div class="form-group">
                <label>License Number:</label>
                <input type="text" id="doctorLicense" placeholder="LIC123456" />
              </div>
              <button onclick="registerDoctor()">Register</button>
              <div id="doctorRegisterStatus"></div>
            </div>

            <div>
              <h3>Request Patient Access</h3>
              <div class="form-group">
                <label>Patient Address:</label>
                <input
                  type="text"
                  id="requestPatientAddress"
                  placeholder="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
                />
              </div>
              <div class="form-group">
                <label>Purpose:</label>
                <textarea
                  id="requestPurpose"
                  rows="3"
                  placeholder="Routine checkup..."
                ></textarea>
              </div>
              <button onclick="requestAccess()">Request Access</button>
              <div id="requestStatus"></div>
            </div>
          </div>

          <div style="margin-top: 30px">
            <h3>Add Medical Record</h3>
            <div class="form-group">
              <label>Patient Address:</label>
              <input
                type="text"
                id="recordPatientAddress"
                placeholder="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
              />
            </div>
            <div class="form-group">
              <label>Record Type:</label>
              <select id="recordType">
                <option>Prescription</option>
                <option>Lab Report</option>
                <option>X-Ray</option>
                <option>CT Scan</option>
                <option>Consultation</option>
              </select>
            </div>
            <div class="form-group">
              <label>Record Details (Hash/ID):</label>
              <input
                type="text"
                id="recordHash"
                placeholder="QmXYZ123... or any record identifier"
              />
            </div>
            <button onclick="addRecord()">Add Record</button>
            <div id="addRecordStatus"></div>
          </div>
        </div>

        <div id="admin" class="tab-content">
          <h2>Admin Panel</h2>
          <div class="form-group">
            <label>Doctor Address to Approve:</label>
            <input
              type="text"
              id="approveDoctorAddress"
              placeholder="0x70997970C51812dc3A010C7d01b50e0d17dc79C8"
            />
          </div>
          <button onclick="approveDoctor()">Approve Doctor</button>
          <div id="adminStatus"></div>
        </div>
      </div>
    </div>

    <script>
      const contractABI = [
        "function registerPatient(string memory _name, uint256 _age, string memory _bloodGroup) public",
        "function registerDoctor(string memory _name, string memory _specialization, string memory _licenseNumber) public",
        "function approveDoctor(address _doctorAddress) public",
        "function addMedicalRecord(address _patientAddress, string memory _recordHash, string memory _recordType) public",
        "function requestAccess(address _patientAddress, string memory _purpose) public",
        "function grantAccess(uint256 _requestId) public",
        "function getPatientRecords(address _patientAddress) public view returns (uint256[] memory)",
        "function getPatientInfo(address _patientAddress) public view returns (string memory name, uint256 age, string memory bloodGroup)",
        "function getDoctorInfo(address _doctorAddress) public view returns (string memory name, string memory specialization, bool isApproved)",
        "function medicalRecords(uint256) public view returns (uint256 recordId, address patientAddress, string recordHash, string recordType, uint256 timestamp, address uploadedBy)",
        "function hasAccess(address _patientAddress, address _doctorAddress) public view returns (bool)",
        "function accessPermissions(address patient, address doctor) public view returns (bool)",
        "event PatientRegistered(address indexed patientAddress, string name)",
        "event DoctorRegistered(address indexed doctorAddress, string name)",
        "event DoctorApproved(address indexed doctorAddress)",
        "event RecordAdded(uint256 indexed recordId, address indexed patientAddress, address indexed doctor)",
        "event AccessRequested(uint256 indexed requestId, address indexed doctor, address indexed patient)",
        "event AccessGranted(address indexed doctor, address indexed patient)",
      ];

      let provider;
      let signer;
      let contract;
      let userAddress;

      function showTab(tabName, event) {
        const tabs = document.querySelectorAll(".tab");
        const contents = document.querySelectorAll(".tab-content");

        tabs.forEach((tab) => tab.classList.remove("active"));
        contents.forEach((content) => content.classList.remove("active"));

        event.target.classList.add("active");
        document.getElementById(tabName).classList.add("active");
      }

      async function connectWallet() {
        if (typeof window.ethereum !== "undefined") {
          try {
            await window.ethereum.request({ method: "eth_requestAccounts" });
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();

            document.getElementById("walletStatus").textContent =
              "Connected ‚úÖ";
            document.getElementById("walletAddress").textContent =
              userAddress.substring(0, 6) + "..." + userAddress.substring(38);

            const contractAddress =
              document.getElementById("contractAddress").value;
            if (contractAddress) {
              contract = new ethers.Contract(
                contractAddress,
                contractABI,
                signer
              );
              showStatus(
                "connectStatus",
                "Connected successfully! ‚úÖ",
                "success"
              );
            } else {
              showStatus(
                "connectStatus",
                "Please enter contract address",
                "error"
              );
            }
          } catch (error) {
            showStatus("connectStatus", "Error: " + error.message, "error");
          }
        } else {
          showStatus(
            "connectStatus",
            "Please install MetaMask! Visit https://metamask.io",
            "error"
          );
        }
      }

      async function registerPatient() {
        if (!contract) {
          alert("Please connect wallet first!");
          return;
        }

        const name = document.getElementById("patientName").value;
        const age = document.getElementById("patientAge").value;
        const bloodGroup = document.getElementById("patientBloodGroup").value;

        if (!name || !age) {
          showStatus(
            "patientRegisterStatus",
            "Please fill all fields",
            "error"
          );
          return;
        }

        try {
          showStatus(
            "patientRegisterStatus",
            "Processing transaction... ‚è≥",
            "info"
          );
          const tx = await contract.registerPatient(name, age, bloodGroup);
          await tx.wait();
          showStatus(
            "patientRegisterStatus",
            "Registered successfully! ‚úÖ",
            "success"
          );
        } catch (error) {
          showStatus(
            "patientRegisterStatus",
            "Error: " + error.message,
            "error"
          );
        }
      }

      async function registerDoctor() {
        if (!contract) {
          alert("Please connect wallet first!");
          return;
        }

        const name = document.getElementById("doctorName").value;
        const spec = document.getElementById("doctorSpec").value;
        const license = document.getElementById("doctorLicense").value;

        if (!name || !spec || !license) {
          showStatus("doctorRegisterStatus", "Please fill all fields", "error");
          return;
        }

        try {
          showStatus(
            "doctorRegisterStatus",
            "Processing transaction... ‚è≥",
            "info"
          );
          const tx = await contract.registerDoctor(name, spec, license);
          await tx.wait();
          showStatus(
            "doctorRegisterStatus",
            "Registered successfully! ‚úÖ (Awaiting admin approval)",
            "success"
          );
        } catch (error) {
          showStatus(
            "doctorRegisterStatus",
            "Error: " + error.message,
            "error"
          );
        }
      }

      async function approveDoctor() {
        if (!contract) {
          alert("Please connect wallet first!");
          return;
        }

        const doctorAddress = document.getElementById(
          "approveDoctorAddress"
        ).value;

        if (!doctorAddress) {
          showStatus("adminStatus", "Please enter doctor address", "error");
          return;
        }

        try {
          showStatus("adminStatus", "Processing transaction... ‚è≥", "info");
          const tx = await contract.approveDoctor(doctorAddress);
          await tx.wait();
          showStatus(
            "adminStatus",
            "Doctor approved successfully! ‚úÖ",
            "success"
          );
        } catch (error) {
          showStatus("adminStatus", "Error: " + error.message, "error");
        }
      }

      async function requestAccess() {
        if (!contract) {
          alert("Please connect wallet first!");
          return;
        }

        const patientAddress = document.getElementById(
          "requestPatientAddress"
        ).value;
        const purpose = document.getElementById("requestPurpose").value;

        if (!patientAddress || !purpose) {
          showStatus("requestStatus", "Please fill all fields", "error");
          return;
        }

        try {
          showStatus("requestStatus", "Processing transaction... ‚è≥", "info");
          const tx = await contract.requestAccess(patientAddress, purpose);
          await tx.wait();
          showStatus(
            "requestStatus",
            "Access requested successfully! ‚úÖ",
            "success"
          );
        } catch (error) {
          showStatus("requestStatus", "Error: " + error.message, "error");
        }
      }

      async function directGrantAccess() {
        if (!contract) {
          alert("Please connect wallet first!");
          return;
        }

        const doctorAddress =
          document.getElementById("grantDoctorAddress").value;

        if (!doctorAddress) {
          showStatus("accessStatus", "Please enter doctor address", "error");
          return;
        }

        try {
          showStatus("accessStatus", "Granting access... ‚è≥", "info");
          const tx = await contract.accessPermissions(
            userAddress,
            doctorAddress
          );
          if (tx) {
            showStatus("accessStatus", "Access already granted! ‚úÖ", "success");
          } else {
            showStatus(
              "accessStatus",
              "Note: You need to use grantAccess(requestId) function in the smart contract. For demo, ask doctor to request access first.",
              "info"
            );
          }
        } catch (error) {
          showStatus(
            "accessStatus",
            "For simplified demo: Use Admin panel to directly call smart contract, or implement request-approve flow",
            "info"
          );
        }
      }

      async function addRecord() {
        if (!contract) {
          alert("Please connect wallet first!");
          return;
        }

        const patientAddress = document.getElementById(
          "recordPatientAddress"
        ).value;
        const recordType = document.getElementById("recordType").value;
        const recordHash = document.getElementById("recordHash").value;

        if (!patientAddress || !recordHash) {
          showStatus("addRecordStatus", "Please fill all fields", "error");
          return;
        }

        try {
          showStatus("addRecordStatus", "Processing transaction... ‚è≥", "info");
          const tx = await contract.addMedicalRecord(
            patientAddress,
            recordHash,
            recordType
          );
          await tx.wait();
          showStatus(
            "addRecordStatus",
            "Record added successfully! ‚úÖ",
            "success"
          );
        } catch (error) {
          showStatus("addRecordStatus", "Error: " + error.message, "error");
        }
      }

      async function getMyRecords() {
        if (!contract) {
          alert("Please connect wallet first!");
          return;
        }

        try {
          const recordIds = await contract.getPatientRecords(userAddress);
          const recordsDiv = document.getElementById("myRecords");
          recordsDiv.innerHTML = "";

          if (recordIds.length === 0) {
            recordsDiv.innerHTML =
              '<p class="info status">No records found</p>';
            return;
          }

          for (let id of recordIds) {
            const record = await contract.medicalRecords(id);
            const date = new Date(record.timestamp * 1000).toLocaleString();

            recordsDiv.innerHTML += `
                        <div class="record-card">
                            <h4>üìÑ ${record.recordType}</h4>
                            <p><strong>Record ID:</strong> ${
                              record.recordId
                            }</p>
                            <p><strong>Hash:</strong> ${record.recordHash}</p>
                            <p><strong>Date:</strong> ${date}</p>
                            <p><strong>Uploaded By:</strong> ${record.uploadedBy.substring(
                              0,
                              6
                            )}...${record.uploadedBy.substring(38)}</p>
                        </div>
                    `;
          }
        } catch (error) {
          document.getElementById(
            "myRecords"
          ).innerHTML = `<p class="error status">Error: ${error.message}</p>`;
        }
      }

      function showStatus(elementId, message, type) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="status ${type}">${message}</div>`;
        setTimeout(() => {
          if (type !== "success") {
            element.innerHTML = "";
          }
        }, 5000);
      }
    </script>
  </body>
</html>
